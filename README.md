# 数字逻辑大作业

## 主题

温湿度检测与数据可视化

## 起因

冬天即将来临，早起困难成为了困扰大学生起床的问题。如果每天早上起床时分，宿舍内的温度温暖舒适，无疑很大程度上减少了起床所需的意志力。

为此：

1. 首先需要设定一个理想温度，并检测室内的温度变化，适时做出调整。
2. 调整的手段，是一个控制空调开启关闭的红外功能。

限于时间与水平，只实现第一个功能，并实现温湿度（主要是温度）的可视化，以便于未来实现红外功能后反映温度的调节效果。

同时也显示湿度，打开空调后，可能室内的湿度会下降，使得湿度不太舒适，是否考虑控制加湿器？

本项目只实现第 1 点。

## 硬件

* Xilinx N4 开发板
* ESP32 开发板（CH340）和数据线
* DHT22 温湿度传感器
* 杜邦线若干

## 软件

* Vivado 2016.2
* Arduino IDE
* VSCode

## 项目结构说明

```plaintext
├── DL_BigHW                存放了 Verilog 文件
│   ├── DL_BigHW.srcs       存放了源文件
│   └── DL_BigHW.xpr        Vivado 项目文件
│
├── arduino                 存放了和 ESP32 有关的文件
│   └── net_connect
│       ├── net_connect.ino 存放了烧录给 ESP32 的代码
│       └── config.h        配置文件，在 Git 中被忽略，其实就是一些全局常量的定义而已
│
├── flask                   和后端有关的文件
│   ├── app.py              后端程序
│   └── config.ini          配置文件，在 Git 中被忽略，按组+项的形式组织起来，常见的 ini 格式
│
└── szlj_vue                        vue 前端
    └── src                         存放了核心源文件
        ├── components              画图组件
        │   └── MyLineChart.vue
        ├── router                  router 路由
        │   └── index.js
        ├── views                   页面
        │   ├── Info.vue
        │   ├── Table.vue
        │   └── Welcome.vue
        ├── App.vue                 根
        └── main.js                 基本配置
```

## 模块

### 模块一：对理想温度的输入

绑定采用五个按钮，理想温度控制在 `10 - 30` 摄氏度。

设置完理想温度后，设置偏差值，也就是，当温度偏移理想温度多少度时，开启空调（目前会把偏差值存放在寄存器中）。

输入的时候，被选中的位会闪烁，显示在七段数码管上。

### 模块二、三：对温湿度的显示

#### 2.1 数码管

T 显示温度，在前四个数码管。H 显示湿度，在后四个数码管。

温度的显示采用小数方式。这里有个问题，如果是零下，怎么办呢？如 -10.2，好像就无法正常显示了，因为位数不够。因此给出如下设定：当温度低于 `-9.9` 度时，显示 `Lo`。幸运的是，正数不用考虑本问题。需要注意的是，有一个小 bug 未修复，如果显示的是 `Lo`，则需要修改 isDot 的值。目前显示出来的是 `L.o`。

需要显示的非数字有：

* 显示零下的温度: `-`
* 显示初始化状态：`Init....`
* 显示温度：`T`
* 温度过低：`Lo`
* 显示湿度：`H`
* 设定温度：`T`
* 设定偏移量：`DIFF`
* 成功：`OK`
* 失败：`FAIL`

`L`, `o`, `I`, `n` ,`i`, `t`, `T`, `H`, `D`, `F`, `-`, `什么都不显示`.

编码如下：

| 非数字 | 四位编码 | 十六进制 |
|--------|----------|--------|
| 空     | 10000     | 10      |
| I      | 10001     | 11      |
| n      | 10010     | 12      |
| i      | 10011     | 13      |
| t      | 10100     | 14      |
| L      | 10101     | 15      |
| o      | 10110     | 16      |
| T      | 10111     | 17      |
| H      | 11000     | 18      |
| D      | 11001     | 19      |
| F      | 11010     | 1A      |
| O      | 11011     | 1B      |
| K      | 11100     | 1C      |
| A      | 11101     | 1D      |
| -      | 11111     | 1F      |

参考：[七段数码管显示非数字（维基百科）](https://en.wikipedia.org/wiki/Seven-segment_display_character_representations)

#### 2.2 三色灯

如果把当前的温湿度采用颜色可视化，会不会更好呢？因此额外通过三色灯显示温度是否舒适，采用一般温度计的显示方法：蓝色表示冷，绿色表示合适，红色表示较热。

配色灵感来源见下图。以 `18.0` 和 `25.0` 作为分界。低于 `18.0`，认为是寒冷；高于 `25.0` 认为是炎；二者之间是舒适温度。不再考虑更加极端的情形。

突然发现有两个三色灯，那么对湿度也可以通过颜色进行可视化展示。标准仍然来源于现实中的温湿度计。 40% - 70% 为舒适，绿色；高于 70% 为蓝色；低于 40% 是红色。

* 蓝色为：`#24AEF0`
* 绿色为：`#3ECF7F`
* 红色为：`#FE706C`

![灵感来源](https://static.xialing.icu/img/thermometer-deli.webp)

PWM 的技术参考了 [https://www.secs.oakland.edu/~llamocca/Courses/ECE2700/F20/FinalProject/Group16_RGB_LED.pdf](https://www.secs.oakland.edu/~llamocca/Courses/ECE2700/F20/FinalProject/Group16_RGB_LED.pdf)

### 模块四：接收温湿度（重点是温度）

通过温湿度传感器，记录温度和湿度，储存在开发板内部。

### 模块五：WiFi 传输

连接到 `Tongji-WiFi`，作为传输内容的无线网络。

连接服务器的后端，都用亚马逊云的吧。新设计一个 DNS 解析。

每 10s 采集一次数据，发送到服务器。

## 计划

### 1. 扩展七段数码管的显示范围（完成）

目前的七段数码管只能显示阿拉伯数字，期望是可以显示出英文字母。思路是进行额外的一位编码，最高位为 0 表示数字，最高位为 1 表示非数字。具体的编码见上方对模块的描述。

同时，增加一个显示 `.` 的选择。

### 2. 将七段数码管的独立显示单独作为一个模块（完成）

在按键时间与 `LED` 灯的作业中，这部分是耦合在一起的，不好。可以单独提取一个模块，并接收一个 3 位长的输入，作为选中的位，它会闪烁，表示被选中。期望，或者说下板绑定的时候，高位对应数码管最左侧。

~~需要对时钟进行分频，可能需要学习 IP 核的使用。~~IP 核不好，频率范围有限，最后还是自己手搓的分频器。

这里注意，一定要把数码管的选择放到时序逻辑里，不然会显示错位。也就是，最高位显示在最右侧的数码管上，剩下的向左偏移一位（详见 module sel_display7 的注释）。如（按数码管的排列顺序），期望展示 `1234567`，实际展示 `2345671`。

### 3. 对按钮的处理（完成）

一共有五个按钮。上下两个负责调整温度或偏移值的大小，有范围限制，按一位一位地选择。

左右两个按钮表示选择不同的位，可以进行循环的左右移动，也就是模运算。

中间的按钮表示开始/继续/结束选择。第一次按下，进入选择功能，输入完温度后，按下，进入偏移量的选择，填写完偏移量后，最后再按下，设定结束。

### 4. 重置设定（完成）

高电平有效，绑定一个开关。高电平，设定的温度和偏移值回到默认值。

注意，充值设定的开关只有在 `SET_TEMP` 阶段有效。所以如果要重置温度和范围，需要先让时序状态进入到 `SET_TEMP`（一个开关），再进行重置（另一个开关）。

### 5. 对三色灯的处理（完成）

采用三种固定的颜色，蓝、绿、红，表示温度的适宜程度，应该比较简单。

但有难度的地方是，三色灯真的是“三色”灯。只能控制三种颜色的小灯泡的亮灭，它们并没有原生的接收不同 `rgb` 值的功能。因此检索到 `PWM`，即控制小灯泡在一个周期（当然不是一个时钟周期，如 `1000` 个时钟周期作为一个周期）内，点亮的时间占比。这样，就可以通过点亮时间占比的不同来控制颜色的强度，从而调整各种颜色的比例，混合出理论上所有 `rgb` 颜色。当然要注意，最大占空比（表示在一个周期内，工作时间与总时间的比值 —— `Wikipedia`）不要超过 `50%`，否则灯泡会很亮，亮瞎我的狗眼。

### 6. 温湿度的获取（完成）

VCC 和 GND 就不说了，对于串口而言，设置为 inout，因为只有一根线，也就是单总线通信。

#### 6.1 建立连接

先保持 2s 的高电平，让 AM2302 进入稳定状态。

输出 1ms 的低电平。

传感器则会输出 20us 的高电平，再输出 80us 的低电平，最后再输出 80us 的高电平，作为响应，表示要准备传输数据。

对于这里电平的检测，不要求精确的多少微秒。主机发送信号的时候严格按照时间来，接收传感器信号的时候可以宽泛一些，只接收高低电平的变化，不然一直接收不到数据了。在实际的电路中，时间波动还是很大的。这里吃了亏。

#### 6.2 数据接收

一共 40 位数据。不管是 0 还是 1，都有一个 50us 的低电平前摇。如果是 0，则是 26-28us 的高电平；如果是 1，则是 70us 的高电平。

因此，检测高低电平的方法是判断高电平维持的时间，到底是 40ms 还是 45ms，根据实际来选择。

温度的最高位 1，表示负数；0 表示正数。温湿度传送过来的大小都是原来大小的 10 倍，因此要注意处理。

注意是湿度在前，温度在后，不要弄反了。

连线的时候也要注意，**不要连反了**！！！！！！其实这里倒是不存在连线连反的问题，在 RX 和 TX 的 UART 协议部分要注意。

协议可以参考：

[waveshare 的文档，和学校发的外设是一个牌子](https://www.waveshare.com/wiki/DHT22_Temperature-Humidity_Sensor)

#### 6.3 数据校验

最后 8 位是校验位，是温湿度的高低 8 位（4 个 8 位）加起来的值，因此校验位有 8 位，并不是什么奇偶校验。如果值不可信，要求重新传输。这里的加法是需要考虑进位的，而不是分隔成一个一个位来相加。譬如说，`1010 + 0111 = 0001`（`6 + 7 = 13`），而不是 `1101`（从左到右，`1 + 0; 0 + 1; 1 + 1; 0 + 1`）。

### 7. WiFi 的连接（完成）

我们实际的 IoT(Internet of Things) 物联网开发并不会使用裸芯片，而是使用把芯片集成在其上的开发板。开发板有许多好处：更多的引脚，更强的功能。但对于我而言，有两点比较重要：

1. 可以使用 `arduino` 进行开发；
2. 可以通过数据线直接把电脑和开发板（不是 Xilinx N4 开发板）连接起来，方便对芯片进行写入。

这里我绕了好大一个弯子，我还奇怪呢，为什么网上各种参考资料都说要用 `arduino`，没有用 `Vitis` 的。`ChatGPT` 也不太行，在我的逼问下不得不服软，说 `Vitis` 也支持 `ESP8266` 的开发。。有时候还是得信搜索引擎。。说了这么多，总结下来就一句话：对无线芯片的开发，需要用到 `Arduino IDE`，去[官网](https://www.arduino.cc/en/software)下载吧！

步骤：

1. 下载支持，把链接 `https://dl.espressif.com/dl/package_esp32_index.json` 填写到`File`->`Preferences`->`Additional boards manager URLs`中。下载的内容很大，而且国内直连比较困难。要么找镜像；要么不心疼流量，开全局 +`TUN`。一定要两个都开喔！
2. 在 `Tools`->`Board`->`esp32`->`ESP32 Dev Module`。
3. 在 `Tools`->`Port` 选择对应串口。我这里选择 `COM5`。
4. 编写程序，`Verify` 后 `Upload` 到板子上。

`ESP32` 连接到学校网络的那一刻，很激动。在计科导课上举起双臂庆祝：

![ESP32连接到学校网络的那一刻，很激动。在计科导课上举起双臂庆祝](https://static.xialing.icu/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-12-09%20135804.webp)

>**注意**：`ESP8266` **不**支持 `5GHz` 的 `WiFi`，而且对双频合一的信号也支持不好。网上有[资料](https://github.com/esp8266/Arduino/issues/8956)说强制 `ESP8266` 只使用 `802.11g` 可以解决问题。我试过了，对于我们学校双频合一的 `WiFi` 网络，没用。所以最后不得不买了 `ESP32`。

在 `ESP32` 同时连接电脑（查看串口输出，用于调试）和 `Xilinx` 开发板（用来接收开发板传来的数据）的情况下，只需要提供一个供电端。换句话说，电脑的 `USB` 串口可以在接收数据的同时进行供电，所以不需要让 `ESP32` 的 `VCC` 和 `GND` 连接开发板的 `PMod` 啦！否则电脑可能会突然蓝屏，`ESP32` 似乎没什么问题。

![蓝屏](https://static.xialing.icu/img/202501141520026.webp)

### 8. `UART` 通信（完成）

选择波特率为 `115200` 进行通信。传输的格式是：

```json
{
// 传输的数据是原数据 * 10
    "temperature": 256,    // 当前温度         2Byte
    "humidity": 589,       // 当前湿度         2Byte
    "ideal_tmp": 260,      // 理想温度         2Byte
    "diff": 35             // 温度的偏差值     1Byte
}
```

约定小端序，低字节在前，高字节在后。一个字节内部，从最低位（位 `0`）开始传输。开发板和 `ESP32` 传输的类型是整型，`ESP32` 传输到服务器的类型也是整型。`Flask` 后端接收到传送的内容后，转换为浮点型，写入到数据库中。

注意的是，要保存好当前的时序状态。如果发送完毕后，又到了 IDLE，很可能标志位会被清零。

> **注意：** 不要把 `RX` 和 `TX` 连反。

关于 `UART` 通信，可以参考：

* [https://www.labcenter.com/blog/sim-uart/](https://www.labcenter.com/blog/sim-uart/)

在硬件发送数据的时候，需要添加起始位和截止位（参见 `send_data.v`）。而 `ESP32` 在读取时自动就会读取处理好的内容，不需要额外处理起止标志。

### 9. 数据包的发送（完成）

需要把数据包传送到网站上，从而记录到服务器的数据库中。

传输数据的 `json` 格式为：

```json
{
    // 传输的数据是原数据 * 10
    "temperature": 256,    // 当前温度
    "humidity": 589,       // 当前湿度
    "ideal_tmp": 260,      // 理想温度
    "diff": 35             // 温度的偏差值
}
```

时间不需要传输，因为服务器后端接收到数据后，会自动在数据库中添加时间戳。

除此之外，`json` 还添加了一些验证字段，如 `mac` 地址、特殊约定等，参见 `net_connect.ino`。现在后端还在运行，但是数据上传的方法已经停用了，所以，不管怎样也传输不了新数据，只能查看已有数据，不必再尝试。

有关如何连接 WPA2/Enterprise，参考了：

* [https://github.com/JeroenBeemster/ESP32-WPA2-enterprise/blob/master/ESP32_WPA2enterprise.ino](https://github.com/JeroenBeemster/ESP32-WPA2-enterprise/blob/master/ESP32_WPA2enterprise.ino)

至于说 `HTTPS` 通信，是在 `AI` 辅助下完成的，涉及设置根证书，从略。

### 10. 网站的设置（完成）

#### 后端

新建一个域名，比如叫 `szlj.xialing.icu`，展示页面的前端。`szlj.xialing.icu/api` 是后端，负责接收数据。

后端验证读取到的数据，对来源的验证：验证 `MAC` 地址和设备名称，此外还有对温湿度合法数据的验证。并把数据写入到数据库中，这都是软件层面的事情了，好做。

后端响应前端发出的时间，按日期请求内容。`WHERE DATE({TIMESTAMP}) = '{date}'`

后端的配置流程如下：

```bash
> mkdir myproject
> cd myproject
> py -3 -m venv .venv # 先创建一个虚拟环境

> .venv\\Scripts\\activate # 激活环境

> pip install flask # 在环境中安装 flask

# 后续可以安装 mysql 支持等等
```

#### 前端

简单地按天数查看温湿度的变化。

返回的 `json` 格式：

```json
{
    "status": "ok",
    "msg": "数据获取成功",
    "data": [
        {
            "temperature": "温度",
            "humidity": "湿度",
            "ideal_temp": "理想温度",
            "diff": "温差",
            "timestamp": "时间戳" // 形如 2025-01-01 00:00:00
        },
        ...
    ]
}
```

前端打算还是用 `vue3`，后端用 `Flask`，这次前端的框架可以换个新的，试试 `ant design`。

整个的配置流程是这样的，先新建一个文件夹，比如叫 `vue`，当然也可以不新建，因为新生成的 `vue` 项目会新建一个文件夹。

```bash
npm create vue@latest
# 进行项目的设置（略）
cd project-name
npm install
```

这样，一个基本的 `vue` 项目就建成了。可以通过 `npm run dev` 来看看默认的前端页面。

如果要安装其他东西，比如对图标的支持，或者 `UI`，则需要在对应的官网上查看安装方法。一般都会支持 `npm` 包管理器：

```bash
npm install vue-chartjs chart.js # 对图表的支持，后者是底层，前者是底层的 vue 化支持
npm install ant-design-vue@4.x --save # 安装 ant design 的 UI
```

画图使用 `vue-Chartjs`

```bash
npm install chartjs-adapter-dayjs-4 # 对时间的处理，可能还安装了 dayjs 等
```

#### 数据库

一个表格，内容存储的格式为：

```json
{
    "temperature",  // 记录的温度，用 FLOAT，如 25.6
    "humidity",     // 记录的湿度，用 FLOAT，如 85.6，其实应该有个百分号，但是无所谓，前端加上就好
    "ideal_tmp",    // 理想的温度，用 FLOAT，如 25.6
    "diff",         // 温度的偏差值，用 FLOAT，如 3.2
    "timestamp",    // 时间戳，如果输入没有提供，则使用数据库生成的
}
```

## 未来展望

1. 红外遥控
2. 自启动
3. 登录查看？那是计科导的事儿

## 更多内容

* 前端数据查看（仅2025年1月初有数据）：[https://szlj.xialing.icu](https://szlj.xialing.icu)
* 介绍视频：[https://www.bilibili.com/video/BV1TJ6UYdEgZ](https://www.bilibili.com/video/BV1TJ6UYdEgZ)
