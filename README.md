# 数字逻辑大作业

## 主题

温湿度检测与数据可视化

## 起因

冬天即将来临，早起困难成为了困扰大学生起床的问题。如果每天早上起床时分，宿舍内的温度温暖舒适，无疑很大程度上减少了起床所需的意志力。

为此：

1. 首先需要设定一个理想温度，并检测室内的温度变化，适时做出调整。
2. 调整的手段，是一个控制空调开启关闭的红外功能。

限于时间与水平，只实现第一个功能，并实现温湿度（主要是温度）的可视化，以便于未来实现红外功能后反映温度的调节效果。

同时也显示湿度，打开空调后，可能室内的湿度会下降，使得湿度不太舒适，是否考虑控制加湿器？

本项目只实现第 1 点。

## 模块

### 模块一：对理想温度的输入

绑定采用五个按钮，理想温度控制在 10 - 30 摄氏度。

设置完理想温度后，设置偏差值，也就是，当温度偏移理想温度多少度时，开启空调（目前会置一个标志位）。

输入的时候，被选中的位会闪烁，显示在七段数码管上。

### 模块二、三：对温湿度的显示

#### 2.1 数码管

T 显示温度，在前四个数码管。H 显示湿度，在后四个数码管。

#### 2.2 三色灯

同时会通过三色灯显示温度是否舒适，采用一般温度计的显示方法：蓝色表示冷，绿色表示合适，红色表示较热。

### 模块四：接收温湿度（主要是温度）

通过温湿度传感器，记录温度和湿度，储存在开发板内部。

### 模块五：WiFi 传输

连接到 `Tongji-WiFi`，作为传输内容的无线网络。

连接服务器的后端，都用亚马逊云的吧。新设计一个 DNS 解析。

每隔 30s 把当前的温湿度传输到服务器？还是只要温湿度变化了就把信息传输到服务器？

## 计划

### 1. 扩展七段数码管的显示范围

目前的七段数码管只能显示阿拉伯数字，期望是可以显示出大写英文字母。思路是进行额外的一位编码，最高位为 0 表示数字，为 1 表示为大写字母，按照低位 0 - 25 的 8421 码来理解字母 A - Z。

同时，增加一个显示 . 的选择。

### 2. 将七段数码管的独立显示单独作为一个模块

在按键时间与 LED 灯的作业中，这部分是耦合在一起的，不好。可以单独提取一个模块，并接收一个 3 位长的输入，作为选中的位，它会闪烁，表示被选中。期望，或者说下板绑定的时候，高位对应数码管最左侧。

需要对时钟进行分频，可能需要学习 IP 核的使用。

### 3. 对按钮的处理

一共有五个按钮。上下两个负责调整温度或偏移值的大小，有范围限制，按一位一位地选择。

左右两个按钮表示选择不同的位，可以进行循环的左右移动，也就是模运算。

中间的按钮表示开始/继续/结束选择。第一次按下，进入选择功能，输入完温度后，按下，进入偏移量的选择，填写完偏移量后，最后再按下，设定结束。

### 4. 重置设定

高电平有效，绑定一个开关。高电平，设定的温度和偏移值回到默认值。

### 5. 对三色灯的处理

采用三种固定的颜色，蓝、绿、红，表示温度的适宜程度，应该比较简单。

### 6. 温湿度的获取

VCC 和 GND 就不说了，对于串口而言，设置为 inout，因为只有一根线。

#### 6.1 建立连接

先保持 2s 的高电平，让 AM2302 进入稳定状态。

输出 1ms 的低电平。

传感器则会输出 20us 的高电平，再输出 80us 的低电平，最后再输出 80us 的高电平，作为响应，表示要准备传输数据。

#### 6.2 数据接收

一共 40 位数据。不管是 0 还是 1，都有一个 50us 的低电平前摇。如果是 0，则是 26-28 us 的高电平；如果是 1，则是 70 us 的高电平。

因此，检测高低电平的方法是判断高电平维持的时间。

温度的最高位 1，表示负数；0 表示正数。温湿度传送过来的大小都是原来大小的 10 倍，因此要注意处理。

#### 6.3 数据校验

最后 8 位是校验位，是温湿度的高低 8 位（4 个 8 位）加起来的值，因此校验位有 8 位，并不是什么奇偶校验。如果值不可信，要求重新传输。

### 7. WiFi 的连接

可能需要通过 `Vitis` 编写程序，连接学校的网络。这个网上都有现成的资料，虽然说同济用的是 `WPA/2 Enterprise` 验证，但是我估计固件是支持的。不过也没关系，我的 `ESP8266` 本身就被集成在了开发板上，实际调试起来也方便。

不能使用 `AT` 指令，因为 `AT` 不支持 `WPA/2 Enterprise`，只能编写更底层的程序。

### 8. 数据包的发送

需要把数据包传送到网站上，从而记录到服务器的数据库中。

传输数据的 `json` 格式为：

```json
{
    "temperature": 25.6,    // 当前温度
    "humidity": 58.9,       // 当前湿度
    "ideal_tmp": 26.0,      // 理想温度
    "diff": 3.5             // 温度的偏差值
}
```

时间不需要传输，因为服务器接收到数据后，会自动在数据库中添加时间戳。

### 9. 网站的设置

新建一个域名，比如叫 `szlj.xialing.icu`，展示页面的前端。`szlj.xialing.icu/api` 是后端，负责接收数据。

后端验证读取到的数据（其实我估计也不用验证，没人闲的没事给我发 `POST` 请求），并写入到数据库中，这都是软件层面的事情了，好做。

前端向后端请求内容，用 `POST`，我想初步搞成那种，过去 24 小时，过去一周这种的类型

## 未来展望

1. 传输数据更安全，`HTTPS` 应该已经可以安排上了，但是内容加密怎么办呢？
2. 红外遥控。
3. 自启动
